---
# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Include distribution specific variables
  include_vars: '{{ lookup("first_found", params) }}'
  vars:
    params:
      files:
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution }}-{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution_major_version }}.yml'
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution }}-{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution_version }}.yml'
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution }}.yml'
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.os_family }}.yml'
        - default.yml
      paths:
        - '{{ role_path }}/vars'

- name: Include distribution specific taks
  include_tasks: '{{ lookup("first_found", params) }}'
  vars:
    params:
      files:
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution }}-{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution_major_version }}.yml'
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution }}-{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution_version }}.yml'
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.distribution }}.yml'
        - '{{ hostvars[hostname_override | default(inventory_hostname)].ansible_facts.os_family }}.yml'
        - default.yml
      paths:
        - '{{ role_path }}/tasks'

- when: sops_installed
  block:
    - name: Download sops test GPG key
      get_url:
        url: https://raw.githubusercontent.com/mozilla/sops/master/pgp/sops_functional_tests_key.asc
        dest: /tmp/sops_functional_tests_key.asc

    - name: Import sops test GPG key
      command: gpg --import /tmp/sops_functional_tests_key.asc
      ignore_errors: true
